type Transaction @entity {
	id:                           ID!
	from:                         Bytes!
	to:                           Bytes!
	value:                        BigInt!
	gasUsed:                      BigInt!
	gasPrice:                     BigInt!
	timestamp:                    BigInt!
	blockNumber:                  BigInt!
	accountTransferEvents:        [AccountTransferEvent!]! @derivedFrom(field: "transaction")
	accountMaintenanceEvent:      [AccountMaintenanceEvent!]! @derivedFrom(field: "transaction")
	reserveOrderEvent:            [LendOrderEvent!]! @derivedFrom(field: "transaction")
	BorrowOrderEvent:             [BorrowOrderEvent!]! @derivedFrom(field: "transaction")
	tradeEvent:                   [TradeEvent!]! @derivedFrom(field: "transaction")
}

# =============================================================================
# =                                                                           =
# =============================================================================
type Token @entity {
	id:                           ID!
	name:                         String!
	symbol:                       String!
	decimals:                     Int!
	transfers:                    [AccountTransferEvent!]! @derivedFrom(field: "token")
	reserves:                     [TokenReserve!]! @derivedFrom(field: "token")
	isLent:                       [LendOrder!]! @derivedFrom(field: "token")
	isBorrowed:                   [BorrowOrder!]! @derivedFrom(field: "principalToken")
	isCollateral:                 [BorrowOrder!]! @derivedFrom(field: "collateralToken")
	asTradeFrom:                  [TradeEvent!]! @derivedFrom(field: "srcToken")
	asTradeTo:                    [TradeEvent!]! @derivedFrom(field: "destToken")
}

type Account @entity {
	id:                           ID!
	users:                        [AccountUser!]! @derivedFrom(field: "account")
	lending:                      [LendOrder!]! @derivedFrom(field: "account")
	borrowing:                    [BorrowOrder!]! @derivedFrom(field: "account")
	transfers:                    [AccountTransferEvent!]! @derivedFrom(field: "account")
	maintenance:                  [AccountMaintenanceEvent!]! @derivedFrom(field: "account")
}

type User @entity {
	id:                           ID!
	accounts:                     [AccountUser!]! @derivedFrom(field: "user")
}

type AccountUser @entity {
	id:                           ID!
	account:                      Account!
	user:                         User!
}

# =============================================================================
# =                         Account - Transfer events                         =
# =============================================================================
interface AccountTransferEvent {
	id:                           ID!
	transaction:                  Transaction!
	timestamp:                    BigInt!
	token:                        Token!
	from:                         Account!
	to:                           Bytes!
	value:                        BigInt!
	by:                           Bytes!
}

type AccountTransferBySystem implements AccountTransferEvent @entity {
	id:                           ID!
	transaction:                  Transaction!
	timestamp:                    BigInt!
	token:                        Token!
	from:                         Account!
	to:                           Bytes!
	value:                        BigInt!
	by:                           Bytes!
}

type AccountTransferByUser implements AccountTransferEvent @entity {
	id:                           ID!
	transaction:                  Transaction!
	timestamp:                    BigInt!
	token:                        Token!
	from:                         Account!
	to:                           Bytes!
	value:                        BigInt!
	by:                           Bytes!
}

# =============================================================================
# =                      Account - Administative events                       =
# =============================================================================
interface AccountMaintenanceEvent {
	id:                           ID!
	transaction:                  Transaction!
	timestamp:                    BigInt!
	account:                      Account!
}

type AccountUserAdded implements AccountMaintenanceEvent @entity {
	id:                           ID!
	transaction:                  Transaction!
	timestamp:                    BigInt!
	account:                      Account!
	user:                         User!
	by:                           Bytes!
}

type AccountUserRemoved implements AccountMaintenanceEvent @entity {
	id:                           ID!
	transaction:                  Transaction!
	timestamp:                    BigInt!
	account:                      Account!
	user:                         User!
	by:                           Bytes!
}

type AccountImplChanged implements AccountMaintenanceEvent @entity {
	id:                           ID!
	transaction:                  Transaction!
	timestamp:                    BigInt!
	account:                      Account!
	newImpl:                      Bytes!
	oldImpl:                      Bytes!
}

# =============================================================================
# =                             Reserve - Lending                             =
# =============================================================================
enum LendOrderStatus {
	ACTIVE
	CLOSED
}

type LendOrder @entity {
	id:                           ID!
	status:                       LendOrderStatus!
	account:                      Account!
	byUser:                       User!
	token:                        Token!
	createdValue:                 BigInt!
	createdTimestamp:             BigInt!
	cumulativeValue:              BigInt!
	cumulativeTimestamp:          BigInt!
	expirationTimestamp:          BigInt!
	updates:                      [LendOrderEvent!]! @derivedFrom(field: "order")
}

interface LendOrderEvent {
	id:                           ID!
	transaction:                  Transaction!
	timestamp:                    BigInt!
	order:                        LendOrder!
}

type LendOrderCreated implements LendOrderEvent @entity {
	id:                           ID!
	transaction:                  Transaction!
	timestamp:                    BigInt!
	order:                        LendOrder!
}

type LendOrderCancelled implements LendOrderEvent @entity {
	id:                           ID!
	transaction:                  Transaction!
	timestamp:                    BigInt!
	order:                        LendOrder!
	by:                           Bytes!
}

type LendOrderCumulativeUpdate implements LendOrderEvent @entity {
	id:                           ID!
	transaction:                  Transaction!
	timestamp:                    BigInt!
	order:                        LendOrder!
	value:                        BigInt!
}

type TokenReserve @entity {
	id:                           ID!
	transaction:                  Transaction!
	timestamp:                    BigInt!
	token:                        Token!
	reserve:                      BigInt!
	profit:                       BigInt!
	loss:                         BigInt!
}

# =============================================================================
# =                            Kernel - Borrowing                             =
# =============================================================================
enum BorrowOrderStatus {
	ACTIVE
	REPAID
	DEFAULTED
}
enum BorrowOrderDefaultedReason{
	DUE_DATE_PASSED
	COLLATERAL_UNSAFE
}

type BorrowOrder @entity {
	id:                           ID!
	status:                       BorrowOrderStatus!
	account:                      Account!
	byUser:                       User!
	principalToken:               Token!
	principalAmount:              BigInt!
	collateralToken:              Token!
	collateralAmount:             BigInt!
	premium:                      BigInt!
	fee:                          BigInt!
	createdTimestamp:             BigInt!
	expirationTimestamp:          BigInt!
	updates:                      [BorrowOrderEvent!]! @derivedFrom(field: "order")
}

interface BorrowOrderEvent {
	id:                           ID!
	transaction:                  Transaction!
	timestamp:                    BigInt!
	order:                        BorrowOrder!
}

type BorrowOrderCreated implements BorrowOrderEvent @entity {
	id:                           ID!
	transaction:                  Transaction!
	timestamp:                    BigInt!
	order:                        BorrowOrder!
}

type BorrowOrderRepaid implements BorrowOrderEvent @entity {
	id:                           ID!
	transaction:                  Transaction!
	timestamp:                    BigInt!
	order:                        BorrowOrder!
	valueRepaid:                  BigInt!
}

type BorrowOrderDefaulted implements BorrowOrderEvent @entity {
	id:                           ID!
	transaction:                  Transaction!
	timestamp:                    BigInt!
	order:                        BorrowOrder!
	reason:                       BorrowOrderDefaultedReason!
}

# =============================================================================
# =                                  Trades                                   =
# =============================================================================
interface TradeEvent {
	id:                           ID!
	transaction:                  Transaction!
	timestamp:                    BigInt!
	from:                         Bytes!
	srcToken:                     Token!
	destToken:                    Token!
	srcTokenValue:                BigInt!
	srcTokenValueLeft:            BigInt!
	destTokenValue:               BigInt!
	destTokenValueMax:            BigInt!
	exchangeRate:                 BigInt!
}

type UniswapTrade implements TradeEvent @entity {
	id:                           ID!
	transaction:                  Transaction!
	timestamp:                    BigInt!
	from:                         Bytes!
	srcToken:                     Token!
	destToken:                    Token!
	srcTokenValue:                BigInt!
	srcTokenValueLeft:            BigInt!
	destTokenValue:               BigInt!
	destTokenValueMax:            BigInt!
	exchangeRate:                 BigInt!
}

type KyberTrade implements TradeEvent @entity {
	id:                           ID!
	transaction:                  Transaction!
	timestamp:                    BigInt!
	from:                         Bytes!
	srcToken:                     Token!
	destToken:                    Token!
	srcTokenValue:                BigInt!
	srcTokenValueLeft:            BigInt!
	destTokenValue:               BigInt!
	destTokenValueMax:            BigInt!
	exchangeRate:                 BigInt!
}
